import { Injectable } from '@nestjs/common';
import { PrismaService } from '../prisma/prisma.service';
import { Context } from 'telegraf';
import { Update, Start, On, Ctx, Command } from 'nestjs-telegraf';

@Update()
@Injectable()
export class BotUpdate {
  constructor(private prisma: PrismaService) {}

  // Admin tekshirish - .env fayldan
  private isAdmin(chatId: string): boolean {
    const adminIds = process.env.ADMIN_CHAT_IDS?.split(',').map(id => id.trim()) || [];
    return adminIds.includes(chatId);
  }

  @Start()
  async handleStart(@Ctx() ctx: Context) {
    const chat: any = ctx.chat;
    const chatId = String(chat.id);

    // User bazaga saqlanadi
    await this.prisma.user.upsert({
      where: { chatId },
      update: {},
      create: {
        chatId,
        username: chat.username ?? null,
      },
    });

    // Admin bo'lsa maxsus xabar
    if (this.isAdmin(chatId)) {
      await ctx.reply(
        'ğŸ‘® Admin Panel\n\n' +
        'ğŸ“¢ Kanal boshqaruvi:\n' +
        '/addchannel - Kanal qo\'shish\n' +
        '/listchannels - Kanallar ro\'yxati\n' +
        '/deletechannel - Kanal o\'chirish\n\n' +
        'ğŸ“¹ Video boshqaruvi:\n' +
        '/addvideo - Video qo\'shish\n' +
        '/stats - Statistika'
      );
      return;
    }

    // Oddiy user uchun kanal tekshirish
    const hasAccess = await this.checkChannelSubscription(ctx);
    if (!hasAccess) {
      return;
    }

    await ctx.reply(
      'âœ… Assalomu alaykum! Botga xush kelibsiz!\n\n' +
      'ğŸ“¹ Video olish uchun kod yuboring (masalan: 187)'
    );
  }

  // ==================== ADMIN COMMANDS ====================

  @Command('admin')
  async adminPanel(@Ctx() ctx: Context) {
    const chatId = String(ctx.chat.id);

    if (!this.isAdmin(chatId)) {
      await ctx.reply('âŒ Sizda admin huquqi yo\'q!');
      return;
    }

    await ctx.reply(
      'ğŸ‘® Admin Panel\n\n' +
      'ğŸ“¢ Kanal boshqaruvi:\n' +
      '/addchannel - Kanal qo\'shish\n' +
      '/listchannels - Kanallar ro\'yxati\n' +
      '/deletechannel - Kanal o\'chirish\n\n' +
      'ğŸ“¹ Video boshqaruvi:\n' +
      '/addvideo - Video qo\'shish\n' +
      '/stats - Statistika'
    );
  }

  @Command('addchannel')
  async addChannelCommand(@Ctx() ctx: Context) {
    const chatId = String(ctx.chat.id);

    if (!this.isAdmin(chatId)) {
      await ctx.reply('âŒ Bu komanda faqat adminlar uchun!');
      return;
    }

    await ctx.reply(
      'ğŸ“¢ Kanal qo\'shish:\n\n' +
      '1ï¸âƒ£ Kanal username yoki ID\n' +
      '2ï¸âƒ£ Kanal nomi\n' +
      '3ï¸âƒ£ Invite link (ixtiyoriy)\n\n' +
      'ğŸ“ Format:\n' +
      '<code>/addchannel @kanal_username | Kanal Nomi | https://t.me/+invitelink</code>\n\n' +
      'âœ… Misol 1 (public kanal):\n' +
      '<code>/addchannel @mycinema | Mening Kino Kanalam</code>\n\n' +
      'âœ… Misol 2 (private kanal):\n' +
      '<code>/addchannel -1001234567890 | Maxfiy Kanal | https://t.me/+abc123xyz</code>\n\n' +
      'ğŸ’¡ Private kanal uchun:\n' +
      '- Kanal ID\'sini olish: kanalga xabar forward qiling @userinfobot ga\n' +
      '- Bot kanalda ADMIN bo\'lishi kerak!',
      { parse_mode: 'HTML' }
    );
  }

  @Command('listchannels')
  async listChannels(@Ctx() ctx: Context) {
    const chatId = String(ctx.chat.id);

    if (!this.isAdmin(chatId)) {
      await ctx.reply('âŒ Bu komanda faqat adminlar uchun!');
      return;
    }

    const channels = await this.prisma.channel.findMany({
      where: { isActive: true },
      orderBy: { createdAt: 'desc' },
    });

    if (channels.length === 0) {
      await ctx.reply('ğŸ“¢ Hozircha kanallar yo\'q.\n\nQo\'shish: /addchannel');
      return;
    }

    let message = 'ğŸ“¢ Kanallar ro\'yxati:\n\n';
    
    channels.forEach((ch, i) => {
      message += `${i + 1}. <b>${ch.channelName}</b>\n`;
      message += `   ğŸ†” ${ch.channelId}\n`;
      message += `   ğŸ”— ${ch.inviteLink || 'Yo\'q'}\n\n`;
    });

    message += `\nğŸ—‘ O'chirish: <code>/deletechannel @kanal_username</code>`;

    await ctx.reply(message, { parse_mode: 'HTML' });
  }

  @Command('deletechannel')
  async deleteChannelCommand(@Ctx() ctx: Context) {
    const chatId = String(ctx.chat.id);

    if (!this.isAdmin(chatId)) {
      await ctx.reply('âŒ Bu komanda faqat adminlar uchun!');
      return;
    }

    await ctx.reply(
      'ğŸ—‘ Kanal o\'chirish:\n\n' +
      'Format: <code>/deletechannel @kanal_username</code>\n' +
      'yoki: <code>/deletechannel -1001234567890</code>\n\n' +
      'Misol:\n' +
      '<code>/deletechannel @mycinema</code>',
      { parse_mode: 'HTML' }
    );
  }

  @Command('stats')
  async stats(@Ctx() ctx: Context) {
    const chatId = String(ctx.chat.id);
    if (!this.isAdmin(chatId)) return;

    const totalUsers = await this.prisma.user.count();
    const totalChannels = await this.prisma.channel.count({ where: { isActive: true } });
    const totalVideos = await this.prisma.video.count();

    await ctx.reply(
      `ğŸ“Š Statistika:\n\n` +
      `ğŸ‘¥ Foydalanuvchilar: ${totalUsers}\n` +
      `ğŸ“¢ Kanallar: ${totalChannels}\n` +
      `ğŸ“¹ Videolar: ${totalVideos}`
    );
  }

  // ==================== TEXT HANDLER ====================

  @On('text')
  async onTextMessage(@Ctx() ctx: Context) {
    const message: any = ctx.message;
    const text = message.text;
    const chatId = String(ctx.chat.id);

    // /addchannel bilan ma'lumot yuborilgan
    if (text.startsWith('/addchannel ')) {
      await this.handleAddChannel(ctx, text);
      return;
    }

    // /deletechannel bilan ma'lumot yuborilgan
    if (text.startsWith('/deletechannel ')) {
      await this.handleDeleteChannel(ctx, text);
      return;
    }

    // Boshqa komandalarni ignore qilamiz
    if (text.startsWith('/')) {
      return;
    }

    // Admin bo'lsa, oddiy text'ni ignore qilamiz
    if (this.isAdmin(chatId)) {
      return;
    }

    // Oddiy user uchun - kanal tekshirish
    const hasAccess = await this.checkChannelSubscription(ctx);
    if (!hasAccess) return;

    // Video kod tekshirish
    const video = await this.prisma.video.findUnique({
      where: { code: text.trim() },
    });

    if (video) {
      await ctx.replyWithVideo(video.fileId, {
        caption: video.title ? `ğŸ“¹ ${video.title}\n\n${video.description || ''}` : undefined,
      });
    } else {
      await ctx.reply('âŒ Bu kod bo\'yicha video topilmadi.');
    }
  }

  // ==================== HANDLERS ====================

  private async handleAddChannel(ctx: Context, text: string) {
    const chatId = String(ctx.chat.id);
    if (!this.isAdmin(chatId)) return;

    const content = text.substring('/addchannel '.length).trim();
    
    if (!content) {
      await ctx.reply('âŒ Ma\'lumot kiritilmadi! /addchannel ni bosing ko\'rsatma olish uchun.');
      return;
    }

    const parts = content.split('|').map(p => p.trim());

    if (parts.length < 2) {
      await ctx.reply(
        'âŒ Noto\'g\'ri format!\n\n' +
        'To\'g\'ri format:\n' +
        '<code>/addchannel @kanal | Kanal Nomi | link</code>',
        { parse_mode: 'HTML' }
      );
      return;
    }

    const channelId = parts[0];
    const channelName = parts[1];
    const inviteLink = parts[2] || null;

    try {
      // Tekshiramiz - bot o'sha kanalda admin ekanmi?
      try {
        const botMember = await ctx.telegram.getChatMember(channelId, ctx.botInfo.id);
        
        if (!['administrator', 'creator'].includes(botMember.status)) {
          await ctx.reply(
            'âš ï¸ Ogohlantirish: Bot bu kanalda admin emas!\n\n' +
            'Bot kanalda admin bo\'lishi kerak, aks holda user tekshirish ishlamaydi.\n\n' +
            'Davom etasizmi?',
            {
              reply_markup: {
                inline_keyboard: [
                  [
                    { text: 'âœ… Ha, qo\'sh', callback_data: `confirm_add:${channelId}:${channelName}:${inviteLink || 'none'}` },
                    { text: 'âŒ Yo\'q', callback_data: 'cancel_add' }
                  ]
                ]
              }
            }
          );
          return;
        }
      } catch (error) {
        await ctx.reply(
          'âŒ Xatolik: Kanal topilmadi yoki bot kanalga qo\'shilmagan!\n\n' +
          '1. Bot kanalda a\'zo bo\'lishi kerak\n' +
          '2. Bot kanalda admin bo\'lishi kerak\n' +
          '3. Kanal ID to\'g\'ri kiritilganiga ishonch hosil qiling'
        );
        return;
      }

      await this.prisma.channel.create({
        data: { channelId, channelName, inviteLink },
      });

      await ctx.reply(
        `âœ… Kanal muvaffaqiyatli qo'shildi!\n\n` +
        `ğŸ“¢ Nomi: ${channelName}\n` +
        `ğŸ†” ID: ${channelId}\n` +
        `ğŸ”— Link: ${inviteLink || 'Yo\'q'}`
      );

    } catch (error: any) {
      if (error.code === 'P2002') {
        await ctx.reply('âŒ Bu kanal allaqachon qo\'shilgan!');
      } else {
        await ctx.reply('âŒ Xatolik yuz berdi: ' + error.message);
      }
    }
  }

  private async handleDeleteChannel(ctx: Context, text: string) {
    const chatId = String(ctx.chat.id);
    if (!this.isAdmin(chatId)) return;

    const channelId = text.split(' ')[1];
    
    if (!channelId) {
      await ctx.reply(
        'âŒ Kanal ID kiriting!\n\n' +
        'Format: <code>/deletechannel @kanal_username</code>\n' +
        'yoki: <code>/deletechannel -1001234567890</code>',
        { parse_mode: 'HTML' }
      );
      return;
    }

    try {
      await this.prisma.channel.delete({
        where: { channelId },
      });
      await ctx.reply(`âœ… Kanal o'chirildi: ${channelId}`);
    } catch (error) {
      await ctx.reply('âŒ Kanal topilmadi!');
    }
  }

  // ==================== CALLBACK QUERY ====================

  @On('callback_query')
  async onCallbackQuery(@Ctx() ctx: Context) {
    const callbackQuery: any = ctx.callbackQuery;
    await ctx.answerCbQuery();

    if (callbackQuery.data === 'check_subscription') {
      const hasAccess = await this.checkChannelSubscription(ctx);
      
      if (hasAccess) {
        await ctx.reply('âœ… Tabriklaymiz! Barcha kanallarga obuna bo\'ldingiz!');
        await ctx.deleteMessage();
      }
      return;
    }

    if (callbackQuery.data.startsWith('confirm_add:')) {
      const chatId = String(ctx.chat.id);
      if (!this.isAdmin(chatId)) return;

      const parts = callbackQuery.data.split(':');
      const channelId = parts[1];
      const channelName = parts[2];
      const inviteLink = parts[3] === 'none' ? null : parts[3];

      try {
        await this.prisma.channel.create({
          data: { channelId, channelName, inviteLink },
        });
        await ctx.editMessageText(`âœ… Kanal qo'shildi: ${channelName}`);
      } catch (error) {
        await ctx.reply('âŒ Xatolik yuz berdi!');
      }
      return;
    }

    if (callbackQuery.data === 'cancel_add') {
      await ctx.editMessageText('âŒ Kanal qo\'shish bekor qilindi.');
    }
  }

  // ==================== CHANNEL CHECK ====================

  private async checkChannelSubscription(ctx: Context): Promise<boolean> {
    const userId = ctx.from.id;
    
    const channels = await this.prisma.channel.findMany({
      where: { isActive: true },
    });

    if (channels.length === 0) return true;

    const notJoinedChannels = [];

    for (const channel of channels) {
      try {
        const member = await ctx.telegram.getChatMember(channel.channelId, userId);
        const isSubscribed = ['member', 'administrator', 'creator'].includes(member.status);
        
        if (!isSubscribed) {
          notJoinedChannels.push(channel);
        }
      } catch (error) {
        console.error(`Kanal tekshirishda xatolik ${channel.channelId}:`, error);
      }
    }

    if (notJoinedChannels.length > 0) {
      const channelButtons = notJoinedChannels.map(ch => [{
        text: `ğŸ“¢ ${ch.channelName}`,
        url: ch.inviteLink || `https://t.me/${ch.channelId.replace('@', '')}`,
      }]);

      const checkButton = [{ 
        text: 'âœ… Tekshirish', 
        callback_data: 'check_subscription' 
      }];

      await ctx.reply(
        'â—ï¸ Botdan foydalanish uchun quyidagi kanallarga obuna bo\'ling:\n\n' +
        'ğŸ‘‡ Kanallarga a\'zo bo\'lib, "âœ… Tekshirish" tugmasini bosing.',
        { 
          reply_markup: { 
            inline_keyboard: [...channelButtons, checkButton]
          } 
        }
      );

      return false;
    }

    return true;
  }
}